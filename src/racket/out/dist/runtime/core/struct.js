"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function makeStructTypeProperty(e){var t=StructTypeProperty.make(e);return Values.make([t,t.getPropertyPredicate(),t.getPropertyAccessor()])}function makeStructType(e){var t=new StructTypeDescriptor(e);return Values.make([t,t.getStructConstructor(),t.getStructPredicate(),t.getStructAccessor(),t.getStructMutator()])}function isStructType(e){return e instanceof StructTypeDescriptor}function structTypeInfo(e){return[e._options.name,e._options.initFieldCount,e._options.autoFieldCount,e.getStructAccessor(),e.getStructMutator(),e._options.immutables,e._options.superType||!1,!1]}function isStructInstance(e){return e instanceof Struct||e instanceof Function&&e.__rjs_struct_object instanceof Struct}function check(e,t){return isStructInstance(e)&&e._desc==t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.propProcedure=void 0;var _freeze=require("babel-runtime/core-js/object/freeze"),_freeze2=_interopRequireDefault(_freeze),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_isInteger=require("babel-runtime/core-js/number/is-integer"),_isInteger2=_interopRequireDefault(_isInteger),_set=require("babel-runtime/core-js/set"),_set2=_interopRequireDefault(_set),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2);exports.makeStructTypeProperty=makeStructTypeProperty,exports.makeStructType=makeStructType,exports.isStructType=isStructType,exports.structTypeInfo=structTypeInfo,exports.isStructInstance=isStructInstance,exports.check=check;var _check=require("./check.js"),C=_interopRequireWildcard(_check),_lib=require("./lib.js"),$=_interopRequireWildcard(_lib),_pair=require("./pair.js"),Pair=_interopRequireWildcard(_pair),_primitive=require("./primitive.js"),_values=require("./values.js"),Values=_interopRequireWildcard(_values),Struct=function(e){function t(e,r){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(0,_classCallCheck3.default)(this,t);var o=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));o._desc=e,C.eq(r.length,o._desc._totalInitFields,$.racketCoreError,"arity mismatch");var n=o._desc._options.guard;if(n){var u=r.concat(i||o._desc._options.constructorName||o._desc._options.name);r=n.apply(null,u).getAll()}o._superStructInstance=!1;var a=o._desc.getSuperType();if(!1!==a){var s=r.slice(0,a._totalInitFields);o._fields=r.slice(a._totalInitFields),o._superStructInstance=a.getStructConstructor().apply(null,s)}else o._fields=r;for(var c=o._desc._options.autoV,l=0;l<o._desc._options.autoFieldCount;l++)o._fields.push(c);return o}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"toString",value:function(){for(var e="",t=0;t<this._fields.length;t++)e+=this._fields[t].toString(),t!==this._fields.length-1&&(e+=" ");return"#(struct:"+this._desc.getName()+" "+e+")"}},{key:"toRawString",value:function(){return this.toString()}},{key:"equals",value:function(e){if(!check(e,this._desc))return!1;if(this._desc._options.inspector)return this===e;for(var t=0;t<this._fields.length;t++)if(!$.isEqual(this._fields[t],e._fields[t]))return!1;return!0}},{key:"getField",value:function(e){if(e>=this._fields.length)throw new Error("TypeError: invalid field at position "+e);return this._fields[e]}},{key:"setField",value:function(e,t){C.truthy(e<this._fields.length,$.racketCoreError,"invalid field at position"),C.falsy(this._desc.isFieldImmutable(e),$.racketCoreError,"field is immutable"),this._fields[e]=t}},{key:"_maybeFindSuperInstance",value:function(e){for(var t=this;!1!==t;t=t._superStructInstance)if(t._desc===e)return t;return!1}}]),t}(_primitive.Primitive),StructTypeDescriptor=function(e){function t(e){(0,_classCallCheck3.default)(this,t);var r=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));r._options=e;var i=e.props&&Pair.listToArray(e.props);if(r._options.props=new _map2.default,i){var o=!0,n=!1,u=void 0;try{for(var a,s=(0,_getIterator3.default)(i);!(o=(a=s.next()).done);o=!0){var c=a.value;c.hd.attachToStructTypeDescriptor(r,c.tl)}}catch(e){n=!0,u=e}finally{try{!o&&s.return&&s.return()}finally{if(n)throw u}}}r._propProcedure=r._findProperty(propProcedure),r._options.autoV=r._options.autoV||!1,r._totalInitFields=e.initFieldCount,e.superType&&(r._totalInitFields+=e.superType._totalInitFields);var l=e.immutables||[];return r._options.immutables=new _set2.default(Pair.listToArray(l)),r._options.immutables.forEach(function(t){(t<0||t>=e.initFieldCount)&&C.raise("invalid index in immutables provided")}),r}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"toString",value:function(){return"#<struct-type:"+this._options.name+">"}},{key:"toRawString",value:function(){return this.toString()}},{key:"getName",value:function(){return this._options.name}},{key:"getSuperType",value:function(){return this._options.superType}},{key:"getApplicableStructObject",value:function(e,t){var r=function(){for(var r=void 0,i=arguments.length,o=Array(i),n=0;n<i;n++)o[n]=arguments[n];if("function"==typeof t)r=t,o.unshift(e);else{if(!(0,_isInteger2.default)(t))throw new Error("ValueError: invalid field at position "+t);r=e.getField(t)}return r.apply(null,o)};return r.__rjs_struct_object=e,r}},{key:"maybeStructObject",value:function(e){return e instanceof Struct?e:e instanceof Function&&e.__rjs_struct_object instanceof Struct&&e.__rjs_struct_object}},{key:"getStructConstructor",value:function(){var e=this;return $.attachReadOnlyProperty(function(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];var o=new Struct(e,r),n=void 0!==e._propProcedure&&!1!==e._propProcedure,u=void 0!==e._options.procSpec&&!1!==e._options.procSpec;return n||u?n?e.getApplicableStructObject(o,e._propProcedure):e.getApplicableStructObject(o,e._options.procSpec):o},"racketProcedureType","struct-constructor")}},{key:"getStructPredicate",value:function(){var e=this;return $.attachReadOnlyProperty(function(t){var r=e.maybeStructObject(t);return r&&r._maybeFindSuperInstance(e)&&!0},"racketProcedureType","struct-predicate")}},{key:"getStructAccessor",value:function(){var e=this;return $.attachReadOnlyProperty(function(t,r){var i=e.maybeStructObject(t);i||C.raise(TypeError,"("+t+" : "+(void 0===t?"undefined":(0,_typeof3.default)(t))+" != "+e._options.name+" object)");var o=i._maybeFindSuperInstance(e);return!1===o&&C.raise($.racketCoreError,"accessor applied to invalid type"),o.getField(r)},"racketProcedureType","struct-accessor")}},{key:"getStructMutator",value:function(){var e=this;return $.attachReadOnlyProperty(function(t,r,i){var o=e.maybeStructObject(t);o||C.raise(TypeError,"("+t+" : "+(void 0===t?"undefined":(0,_typeof3.default)(t))+" != "+e._options.name+" object)");var n=o._maybeFindSuperInstance(e);return!1===n&&C.raise($.racketCoreError,"mutator applied to invalid type"),n.setField(r,i)},"racketProcedureType","struct-mutator")}},{key:"_findProperty",value:function(e){for(var t=this;t;t=t.getSuperType()){var r=t._options.props.get(e);if(void 0!==r)return r}}},{key:"isFieldImmutable",value:function(e){return this._options.immutables.has(e)}}],[{key:"make",value:function(e){return(0,_freeze2.default)(new t(e))}}]),t}(_primitive.Primitive),StructTypeProperty=function(e){function t(e){(0,_classCallCheck3.default)(this,t);var r=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));return r._name=e.name.toString(),r._guard=e.guard||!1,r._canImpersonate=e.canImpersonate||!1,r._supers=e.supers&&Pair.listToArray(e.supers)||[],r}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"toString",value:function(){return"#<struct-type-property:"+this._name+">"}},{key:"toRawString",value:function(){return this.toString()}},{key:"getPropertyPredicate",value:function(){var e=this;return function(t){if(t instanceof StructTypeDescriptor)r=t;else{if(!(t instanceof Struct))return!1;var r=t._desc}return void 0!==r._findProperty(e)}}},{key:"getPropertyAccessor",value:function(){var e=this;return function(t){if(t instanceof StructTypeDescriptor)r=t;else if(t instanceof Struct)var r=t._desc;else C.raise($.racketCoreError,"invalid argument to accessor");return r._findProperty(e)||C.raise($.racketCoreError,"property not in struct")}}},{key:"attachToStructTypeDescriptor",value:function(e,t){var r=t;this._guard&&(r=this._guard(t,Pair.listFromArray(structTypeInfo(e)))),e._options.props.set(this,r),this._supers.forEach(function(t){var i=t.hd,o=t.tl;i.attachToStructTypeDescriptor(e,o(r))})}}],[{key:"make",value:function(e){return(0,_freeze2.default)(new t(e))}}]),t}(_primitive.Primitive),propProcedure=exports.propProcedure=makeStructTypeProperty({name:"prop:procedure"}).getAt(0);