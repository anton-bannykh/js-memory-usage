"use strict";function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n]);return r.default=t,r}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function init(){__frames=Pair.Empty,savePrompt(__defaultContinuationPromptTag),enterFrame()}function registerAsynCallbackWrapper(t){__async_callback_wrappers.push(t)}function defaultContinuationPromptTag(){return __defaultContinuationPromptTag}function ContinuationPromptTag(t){return this.tag=t,this}function AbortCurrentContinuation(t,r){this.name="abort-current-continuation",this.promptTag=t,this.handlerArgs=r,this.stack=(new Error).stack,Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack}function savePrompt(t){var r=__prompts.get(t);void 0===r&&(r=[],__prompts.set(t,r)),r.push(__frames.hd)}function deleteCurrentPrompt(t){var r=__prompts.get(t);if(void 0===r)throw $.racketCoreError("No corresponding tag in continuation!");r.pop(),0===r.length&&__prompts.delete(t)}function getPromptFrame(t){if(void 0===t)return t;var r=__prompts.get(t);return r&&r[r.length-1]||void 0}function makeContinuationPromptTag(t){return new ContinuationPromptTag(t)}function isContinuationPromptTag(t){return t instanceof ContinuationPromptTag}function callWithContinuationPrompt(t,r,n){r=r||__defaultContinuationPromptTag;try{savePrompt(r);for(var e=arguments.length,o=Array(e>3?e-3:0),a=3;a<e;a++)o[a-3]=arguments[a];return t.apply(null,o)}catch(t){if(t instanceof AbortCurrentContinuation&&t.promptTag===r)return n.apply(null,t.handlerArgs);throw t}finally{deleteCurrentPrompt(r)}}function getFrames(){return __frames}function updateFrame(t,r){if(__frames!==r)throw new Error("current frame doesn't match with old frame");return __frames=t}function enterFrame(){return __frames=Pair.make({},__frames)}function setMark(t,r){__frames.hd[HASH(t)]=r}function getContinuationMarks(t){var r=__frames,n=getPromptFrame(t=t||__defaultContinuationPromptTag);if(void 0===n&&t!==__defaultContinuationPromptTag)throw $.racketCoreError("No corresponding tag in continuation!");for(var e=[];!Pair.isEmpty(r)&&r.hd!==n;)e.push(r.hd),r=r.tl;return e}function getMarks(t,r,n){n=n||__defaultContinuationPromptTag;for(var e=HASH(r),o=getPromptFrame(n),a=[],i=0;i<t.length;++i){var u=t[i];if(e in u){if(u===o)break;a.push(u[e])}}return Pair.listFromArray(a)}function getFirstMark(t,r,n){var e=HASH(r);return Pair.listFind(t,function(t){if(e in t)return t[e]})||n}function wrapWithContext(t){return function(r){var n={};return __async_callback_wrappers.forEach(function(t){return t.onCreate(n)}),function(){init(),__async_callback_wrappers.forEach(function(t){return t.onInvoke(n)});try{for(var r=arguments.length,e=Array(r),o=0;o<r;o++)e[o]=arguments[o];return t.apply(null,e)}finally{__frames=void 0}}}()}Object.defineProperty(exports,"__esModule",{value:!0});var _create=require("babel-runtime/core-js/object/create"),_create2=_interopRequireDefault(_create),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map);exports.init=init,exports.registerAsynCallbackWrapper=registerAsynCallbackWrapper,exports.defaultContinuationPromptTag=defaultContinuationPromptTag,exports.AbortCurrentContinuation=AbortCurrentContinuation,exports.makeContinuationPromptTag=makeContinuationPromptTag,exports.isContinuationPromptTag=isContinuationPromptTag,exports.callWithContinuationPrompt=callWithContinuationPrompt,exports.getFrames=getFrames,exports.updateFrame=updateFrame,exports.enterFrame=enterFrame,exports.setMark=setMark,exports.getContinuationMarks=getContinuationMarks,exports.getMarks=getMarks,exports.getFirstMark=getFirstMark,exports.wrapWithContext=wrapWithContext;var _pair=require("./pair.js"),Pair=_interopRequireWildcard(_pair),_symbol=require("./symbol.js"),_Symbol=_interopRequireWildcard(_symbol),_lib=require("./lib.js"),$=_interopRequireWildcard(_lib),__frames=!1,__prompts=new _map2.default,__async_callback_wrappers=[],__defaultContinuationPromptTag=makeContinuationPromptTag(_Symbol.make("default")),HASH=$.hashEq;init(),AbortCurrentContinuation.prototype=(0,_create2.default)(Error.prototype),AbortCurrentContinuation.prototype.constructor=AbortCurrentContinuation;